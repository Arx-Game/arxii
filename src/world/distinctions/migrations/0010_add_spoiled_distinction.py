# Generated by Django 5.2.4 on 2026-01-28

from django.db import migrations


def add_spoiled_distinction(apps, schema_editor):
    """Add Spoiled distinction with physical skill development penalty."""
    DistinctionCategory = apps.get_model("distinctions", "DistinctionCategory")
    Distinction = apps.get_model("distinctions", "Distinction")
    DistinctionEffect = apps.get_model("distinctions", "DistinctionEffect")
    ModifierType = apps.get_model("mechanics", "ModifierType")

    # Get or create the Personality category
    personality, _ = DistinctionCategory.objects.get_or_create(
        slug="personality",
        defaults={
            "name": "Personality",
            "description": "Character personality traits and behavioral tendencies",
            "display_order": 3,
        },
    )

    # Get the development rate modifier type
    physical_dev_rate = ModifierType.objects.get(
        category__name="development",
        name="physical_skill_development_rate",
    )

    # Create the Spoiled distinction
    spoiled, created = Distinction.objects.get_or_create(
        slug="spoiled",
        defaults={
            "name": "Spoiled",
            "description": (
                "A life of comfort has left you ill-prepared for hardship. "
                "Physical exertion and discomfort are foreign to you, making it "
                "harder to develop physical skills through practice."
            ),
            "category": personality,
            "cost_per_rank": -10,  # Disadvantage: reimburses 10 points
            "max_rank": 1,
            "is_active": True,
        },
    )

    if created:
        # Create the effect: -20% physical skill development rate
        # Value is stored as percentage modifier (-20 = 20% slower)
        DistinctionEffect.objects.create(
            distinction=spoiled,
            target=physical_dev_rate,
            value_per_rank=-20,
            description="Physical skills develop 20% slower",
        )


def remove_spoiled_distinction(apps, schema_editor):
    """Remove the Spoiled distinction."""
    Distinction = apps.get_model("distinctions", "Distinction")
    # CASCADE will delete the effects
    Distinction.objects.filter(slug="spoiled").delete()


class Migration(migrations.Migration):
    dependencies = [
        ("distinctions", "0009_add_giants_blood_distinction"),
        ("mechanics", "0006_add_stat_height_development_modifiers"),
    ]

    operations = [
        migrations.RunPython(
            add_spoiled_distinction,
            remove_spoiled_distinction,
        ),
    ]
