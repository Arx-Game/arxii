# Generated by Django 5.2.4 on 2026-01-28

from django.db import migrations

# All 30 resonance types in the system
RESONANCE_NAMES = [
    "Allure",
    "Beast",
    "Bonds",
    "Command",
    "Cunning",
    "Death",
    "Decay",
    "Dreams",
    "Fate",
    "Fear",
    "Flame",
    "Fury",
    "Grace",
    "Growth",
    "Ice",
    "Life",
    "Majesty",
    "Mind",
    "Presence",
    "Protection",
    "Radiance",
    "Shadows",
    "Space",
    "Spirit",
    "Steel",
    "Stone",
    "Storm",
    "Time",
    "Vengeance",
    "Water",
]


def add_magical_scar_distinctions(apps, schema_editor):
    """
    Add Magical Scar distinction with variants for each resonance type.

    Creates:
    - A "magical-scar" tag for filtering
    - A parent "Magical Scar" distinction (grouping only)
    - 30 variant distinctions (one per resonance)
    - Effects granting 5 resonance per rank
    - Mutual exclusivity between all variants (only one scar per character)
    """
    DistinctionCategory = apps.get_model("distinctions", "DistinctionCategory")
    DistinctionTag = apps.get_model("distinctions", "DistinctionTag")
    Distinction = apps.get_model("distinctions", "Distinction")
    DistinctionEffect = apps.get_model("distinctions", "DistinctionEffect")
    ModifierCategory = apps.get_model("mechanics", "ModifierCategory")
    ModifierType = apps.get_model("mechanics", "ModifierType")

    # Get the Arcane category
    arcane, _ = DistinctionCategory.objects.get_or_create(
        slug="arcane",
        defaults={
            "name": "Arcane",
            "description": "Distinctions related to magical abilities and supernatural phenomena.",
            "display_order": 6,
        },
    )

    # Create the magical-scar tag
    scar_tag, _ = DistinctionTag.objects.get_or_create(
        slug="magical-scar",
        defaults={"name": "Magical Scar"},
    )

    # Get or create the resonance category
    # (May not exist in test environments where fixtures aren't loaded)
    resonance_category, _ = ModifierCategory.objects.get_or_create(
        name="resonance",
        defaults={
            "description": "Magical resonance types",
            "display_order": 4,
        },
    )

    # Create the parent distinction (not selectable directly, just a grouping)
    parent, created = Distinction.objects.get_or_create(
        slug="magical-scar",
        defaults={
            "name": "Magical Scar",
            "description": (
                "Through a Glimpse, magical mishap, or other supernatural event, "
                "you bear a scar that resonates with a particular type of magic. "
                "This mark grants you an innate connection to that resonance."
            ),
            "category": arcane,
            "cost_per_rank": 5,  # 5 points per rank
            "max_rank": 3,  # Maximum 3 ranks
            "is_active": True,
            "allow_other": False,  # Must choose a specific resonance
        },
    )

    if not created:
        # Parent already exists, skip creation
        return

    parent.tags.add(scar_tag)

    # Track all variants for mutual exclusivity
    variants = []

    # Create a variant for each resonance type
    for i, resonance_name in enumerate(RESONANCE_NAMES):
        # Get or create the resonance ModifierType
        # (May not exist in test environments where fixtures aren't loaded)
        resonance, _ = ModifierType.objects.get_or_create(
            category=resonance_category,
            name=resonance_name,
            defaults={
                "description": f"Magical resonance: {resonance_name}",
                "display_order": i + 1,
                "is_active": True,
            },
        )

        slug = f"magical-scar-{resonance_name.lower()}"
        variant, variant_created = Distinction.objects.get_or_create(
            slug=slug,
            defaults={
                "name": f"Magical Scar: {resonance_name}",
                "description": (
                    f"Your magical scar resonates with {resonance_name}. "
                    f"You gain {resonance_name} resonance points from this connection."
                ),
                "category": arcane,
                "cost_per_rank": 5,
                "max_rank": 3,
                "is_active": True,
                "parent_distinction": parent,
            },
        )

        if variant_created:
            variant.tags.add(scar_tag)
            variants.append(variant)

            # Create the effect: +5 resonance per rank
            DistinctionEffect.objects.create(
                distinction=variant,
                target=resonance,
                value_per_rank=5,
                description=f"+5 {resonance_name} resonance per rank",
            )

    # Set up mutual exclusivity between all variants
    # Each variant should be mutually exclusive with all other variants
    for i, variant in enumerate(variants):
        # Add all other variants as mutually exclusive
        other_variants = variants[:i] + variants[i + 1 :]
        variant.mutually_exclusive_with.add(*other_variants)


def remove_magical_scar_distinctions(apps, schema_editor):
    """Remove all Magical Scar distinctions."""
    Distinction = apps.get_model("distinctions", "Distinction")
    DistinctionTag = apps.get_model("distinctions", "DistinctionTag")

    # Delete the parent (CASCADE will delete variants and effects)
    Distinction.objects.filter(slug="magical-scar").delete()

    # Also delete variants explicitly (in case parent wasn't found)
    for resonance_name in RESONANCE_NAMES:
        Distinction.objects.filter(slug=f"magical-scar-{resonance_name.lower()}").delete()

    # Delete the tag
    DistinctionTag.objects.filter(slug="magical-scar").delete()


class Migration(migrations.Migration):
    dependencies = [
        ("distinctions", "0010_add_spoiled_distinction"),
        ("mechanics", "0006_add_stat_height_development_modifiers"),
    ]

    operations = [
        migrations.RunPython(
            add_magical_scar_distinctions,
            remove_magical_scar_distinctions,
        ),
    ]
