# Generated by Django 5.2.4 on 2026-02-05
"""
Remove redundant Allure definition from Attractive distinction effect.

The effect description was showing verbose text like "Adds an Allure modifier
based on rank (bonus on social checks with those who find character attractive)"
which explains what Allure means rather than showing the mechanical effect.

Updates to match the standard effect description format (e.g., "+10 Allure.").
Players will learn what Allure means via CodexTerm entries.
"""

from django.db import migrations


def fix_attractive_allure_description(apps, schema_editor):
    """Update Attractive distinction's Allure effect to use concise description."""
    DistinctionEffect = apps.get_model("distinctions", "DistinctionEffect")

    # Find the Allure effect for the Attractive distinction
    # Use case-insensitive matching since the actual data has "Allure" (capitalized)
    # and category is "stat" not "roll_modifier"
    effects = DistinctionEffect.objects.filter(
        distinction__slug="attractive",
        target__name__iexact="allure",
        target__category__name="stat",
    )

    for effect in effects:
        # Determine the value to show
        if effect.value_per_rank is not None:
            value = effect.value_per_rank
            if effect.distinction.max_rank > 1:
                new_description = f"+{value} Allure per rank."
            else:
                new_description = f"+{value} Allure."
        elif effect.scaling_values:
            # Format scaling values like "+10/20/30 Allure per rank."
            values = "/".join(str(v) for v in effect.scaling_values)
            new_description = f"+{values} Allure per rank."
        else:
            new_description = "+Allure modifier."

        if effect.description != new_description:
            print(
                f"  Updated Attractive Allure effect: '{effect.description}' -> '{new_description}'"
            )
            effect.description = new_description
            effect.save()


def reverse_attractive_allure_description(apps, schema_editor):
    """Restore a placeholder description (exact original unknown)."""
    DistinctionEffect = apps.get_model("distinctions", "DistinctionEffect")

    DistinctionEffect.objects.filter(
        distinction__slug="attractive",
        target__name__iexact="allure",
        target__category__name="stat",
    ).update(
        description="Grants +5 Allure per rank when interacting with targets who find you attractive."
    )


class Migration(migrations.Migration):
    dependencies = [
        ("distinctions", "0004_fix_resonance_description_names"),
    ]

    operations = [
        migrations.RunPython(
            fix_attractive_allure_description,
            reverse_attractive_allure_description,
        ),
    ]
