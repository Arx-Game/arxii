# Generated by Django 5.2.4 on 2026-01-28 02:51

from django.db import migrations


def add_indolent_distinction(apps, schema_editor):
    """Add the Indolent distinction with AP regen penalty effects."""
    DistinctionCategory = apps.get_model("distinctions", "DistinctionCategory")
    Distinction = apps.get_model("distinctions", "Distinction")
    DistinctionEffect = apps.get_model("distinctions", "DistinctionEffect")
    ModifierType = apps.get_model("mechanics", "ModifierType")

    # Get or create the Personality category (may not exist in test DB)
    personality, _ = DistinctionCategory.objects.get_or_create(
        slug="personality",
        defaults={
            "name": "Personality",
            "description": "Character personality traits and behavioral tendencies",
            "display_order": 3,
        },
    )

    # Get the AP regen modifier types
    daily_regen = ModifierType.objects.get(
        category__name="action_points",
        name="ap_daily_regen",
    )
    weekly_regen = ModifierType.objects.get(
        category__name="action_points",
        name="ap_weekly_regen",
    )

    # Create the Indolent distinction
    indolent, created = Distinction.objects.get_or_create(
        slug="indolent",
        defaults={
            "name": "Indolent",
            "description": (
                "Whether due to a lack of motivation or believing that exertion "
                "is for other people, you aren't known for excessive effort."
            ),
            "category": personality,
            "cost_per_rank": -15,  # Disadvantage: reimburses 15 points
            "max_rank": 1,
            "is_active": True,
        },
    )

    if created:
        # Create the effects
        DistinctionEffect.objects.create(
            distinction=indolent,
            target=daily_regen,
            value_per_rank=-2,
            description="Reduces daily AP regeneration by 2",
        )
        DistinctionEffect.objects.create(
            distinction=indolent,
            target=weekly_regen,
            value_per_rank=-40,
            description="Reduces weekly AP regeneration by 40",
        )


def remove_indolent_distinction(apps, schema_editor):
    """Remove the Indolent distinction."""
    Distinction = apps.get_model("distinctions", "Distinction")
    # CASCADE will delete the effects
    Distinction.objects.filter(slug="indolent").delete()


class Migration(migrations.Migration):
    dependencies = [
        ("distinctions", "0006_add_effect_meta_modifiers"),
        ("mechanics", "0004_add_action_points_modifiers"),
    ]

    operations = [
        migrations.RunPython(
            add_indolent_distinction,
            remove_indolent_distinction,
        ),
    ]
