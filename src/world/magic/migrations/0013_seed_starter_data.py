# Generated by Django 5.2.4 on 2026-02-01 05:39

from django.db import migrations


def seed_technique_styles(apps, schema_editor):
    """Seed TechniqueStyle records with path restrictions."""
    TechniqueStyle = apps.get_model("magic", "TechniqueStyle")
    Path = apps.get_model("classes", "Path")

    styles_data = [
        ("Manifestation", "Obvious emanating powers that visibly originate from the caster."),
        ("Subtle", "Hidden powers where the source may not be obvious."),
        ("Imbued", "Powers invested in the self, like stat buffs or passives."),
        ("Prayer", "Divine-styled powers invoking higher forces."),
        ("Incantation", "Traditional spell-casting with verbal and somatic components."),
    ]

    # Path restrictions: empty list means all paths allowed
    style_paths = {
        "Manifestation": [],  # All paths
        "Subtle": ["Path of the Voice", "Path of Whispers"],
        "Imbued": ["Path of Whispers", "Path of Steel"],
        "Prayer": ["Path of the Acolyte"],
        "Incantation": ["Path of the Academic"],
    }

    for name, description in styles_data:
        style, _ = TechniqueStyle.objects.get_or_create(
            name=name,
            defaults={"description": description},
        )
        # Set path restrictions if any paths exist
        path_names = style_paths.get(name, [])
        if path_names:
            paths = Path.objects.filter(name__in=path_names)
            if paths.exists():
                style.allowed_paths.set(paths)


def seed_effect_types(apps, schema_editor):
    """Seed EffectType records."""
    EffectType = apps.get_model("magic", "EffectType")

    # Format: (name, description, base_power, base_anima_cost, has_power_scaling)
    effect_types_data = [
        ("Attack", "Deal damage to target(s).", 10, 2, True),
        ("Defense", "Mitigate or avoid incoming damage.", 10, 2, True),
        ("Buff", "Enhance a stat or ability.", 10, 2, True),
        ("Debuff", "Impair enemy stat or ability.", 10, 2, True),
        ("Movement", "Teleport, flight, enhanced speed.", None, 3, False),
        ("Concealment", "Hide self or others from detection.", None, 2, False),
        ("Perception", "Detect hidden things, see through illusions.", None, 1, False),
        ("Summon", "Conjure objects or creatures.", None, 3, False),
    ]

    for name, description, base_power, base_anima_cost, has_power_scaling in effect_types_data:
        EffectType.objects.get_or_create(
            name=name,
            defaults={
                "description": description,
                "base_power": base_power,
                "base_anima_cost": base_anima_cost,
                "has_power_scaling": has_power_scaling,
            },
        )


def seed_restrictions(apps, schema_editor):
    """Seed Restriction records with effect type associations."""
    Restriction = apps.get_model("magic", "Restriction")
    EffectType = apps.get_model("magic", "EffectType")

    # Format: (name, description, power_bonus, allowed_effect_type_names)
    # Empty list for allowed_effect_type_names means all effect types allowed
    restrictions_data = [
        ("Touch Range", "Must physically touch target.", 10, ["Attack", "Buff", "Debuff"]),
        ("Line of Sight", "Target must be visible.", 5, ["Attack", "Defense", "Debuff"]),
        ("Self Only", "Can only target self.", 10, ["Buff", "Defense"]),
        ("Single Target", "Cannot affect multiple targets.", 5, ["Attack", "Debuff"]),
        ("Stationary", "Cannot move while using.", 5, ["Defense", "Buff", "Concealment"]),
        ("Concentration", "Ends if concentration broken.", 5, ["Buff", "Defense", "Concealment"]),
        ("Sentient Only", "Only affects thinking minds.", 10, ["Attack", "Debuff", "Buff"]),
        ("Undead Only", "Only affects undead.", 10, ["Attack", "Debuff"]),
        ("Living Only", "Only affects living creatures.", 5, ["Attack", "Debuff"]),
        ("Animals Only", "Only affects animals/beasts.", 10, ["Attack", "Debuff", "Buff"]),
        ("Situational", "Only works in specific conditions.", 10, []),  # All types
        ("Delayed", "Effect happens next turn.", 5, ["Attack", "Debuff"]),
        ("Verbal", "Requires speaking.", 5, []),  # All types
        ("Material", "Requires specific item/component.", 5, []),  # All types
    ]

    for name, description, power_bonus, effect_type_names in restrictions_data:
        restriction, _ = Restriction.objects.get_or_create(
            name=name,
            defaults={
                "description": description,
                "power_bonus": power_bonus,
            },
        )
        # Set allowed effect types
        if effect_type_names:
            effect_types = EffectType.objects.filter(name__in=effect_type_names)
            if effect_types.exists():
                restriction.allowed_effect_types.set(effect_types)
        # Empty list means all types are allowed - leave M2M empty (model interprets this as "all")


def seed_resonance_associations(apps, schema_editor):
    """Seed ResonanceAssociation records."""
    ResonanceAssociation = apps.get_model("magic", "ResonanceAssociation")

    # Format: (name, description, category)
    associations_data = [
        # Animals
        ("Spiders", "Eight-legged hunters and web-weavers.", "Animals"),
        ("Wolves", "Pack hunters and symbols of loyalty.", "Animals"),
        ("Serpents", "Venomous, cunning creatures.", "Animals"),
        ("Ravens", "Omens and messengers.", "Animals"),
        ("Bats", "Creatures of the night.", "Animals"),
        # Elements
        ("Fire", "Flames, heat, destruction.", "Elements"),
        ("Ice", "Cold, frost, preservation.", "Elements"),
        ("Lightning", "Speed, power, storms.", "Elements"),
        ("Shadow", "Darkness, concealment.", "Elements"),
        ("Light", "Illumination, purity.", "Elements"),
        # Concepts
        ("Death", "Endings, mortality.", "Concepts"),
        ("Life", "Growth, vitality.", "Concepts"),
        ("Fear", "Terror, intimidation.", "Concepts"),
        ("Desire", "Attraction, temptation.", "Concepts"),
        ("Command", "Authority, control.", "Concepts"),
        # Materials
        ("Silk", "Fine threads, binding.", "Materials"),
        ("Steel", "Weapons, armor, strength.", "Materials"),
        ("Blood", "Life force, sacrifice.", "Materials"),
        ("Bone", "Death, structure.", "Materials"),
        ("Crystal", "Clarity, focus.", "Materials"),
    ]

    for name, description, category in associations_data:
        ResonanceAssociation.objects.get_or_create(
            name=name,
            defaults={
                "description": description,
                "category": category,
            },
        )


def reverse_seed(apps, schema_editor):
    """Reverse migration - optional, does nothing."""


class Migration(migrations.Migration):
    dependencies = [
        ("magic", "0012_add_draft_anima_ritual"),
        ("classes", "0001_initial"),  # For Path model used in TechniqueStyle.allowed_paths
    ]

    operations = [
        migrations.RunPython(seed_technique_styles, reverse_seed),
        migrations.RunPython(seed_effect_types, reverse_seed),
        migrations.RunPython(seed_restrictions, reverse_seed),
        migrations.RunPython(seed_resonance_associations, reverse_seed),
    ]
