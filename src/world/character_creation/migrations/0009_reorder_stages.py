# Generated by Django 5.2.4 on 2026-02-06 18:57

from django.db import migrations

# Old stage numbers being swapped
OLD_ATTRIBUTES = 4
OLD_DISTINCTIONS = 6


def remap_stages_forward(apps, schema_editor):
    """Remap stage numbers for CG reorder.

    Old: ATTRIBUTES=4, PATH_SKILLS=5, DISTINCTIONS=6
    New: DISTINCTIONS=4, PATH_SKILLS=5, ATTRIBUTES=6
    """
    CharacterDraft = apps.get_model("character_creation", "CharacterDraft")

    for draft in CharacterDraft.objects.all():
        changed = False

        # Remap current_stage: swap 4 and 6 (5 stays)
        if draft.current_stage == OLD_ATTRIBUTES:
            draft.current_stage = OLD_DISTINCTIONS
            changed = True
        elif draft.current_stage == OLD_DISTINCTIONS:
            draft.current_stage = OLD_ATTRIBUTES
            changed = True

        # Remap stage_completion keys (stored as JSON with string keys)
        completion = draft.draft_data.get("stage_completion", {})
        if completion:
            old_4 = completion.pop("4", None)
            old_6 = completion.pop("6", None)
            if old_4 is not None:
                completion["6"] = old_4
            if old_6 is not None:
                completion["4"] = old_6
            draft.draft_data["stage_completion"] = completion
            changed = True

        if changed:
            draft.save(update_fields=["current_stage", "draft_data", "updated_at"])


def remap_stages_backward(apps, schema_editor):
    """Reverse the stage remap (same swap: 4<->6)."""
    CharacterDraft = apps.get_model("character_creation", "CharacterDraft")

    for draft in CharacterDraft.objects.all():
        changed = False

        if draft.current_stage == OLD_ATTRIBUTES:
            draft.current_stage = OLD_DISTINCTIONS
            changed = True
        elif draft.current_stage == OLD_DISTINCTIONS:
            draft.current_stage = OLD_ATTRIBUTES
            changed = True

        completion = draft.draft_data.get("stage_completion", {})
        if completion:
            new_4 = completion.pop("4", None)
            new_6 = completion.pop("6", None)
            if new_4 is not None:
                completion["6"] = new_4
            if new_6 is not None:
                completion["4"] = new_6
            draft.draft_data["stage_completion"] = completion
            changed = True

        if changed:
            draft.save(update_fields=["current_stage", "draft_data", "updated_at"])


class Migration(migrations.Migration):
    dependencies = [
        ("character_creation", "0008_alter_characterdraft_current_stage"),
    ]

    operations = [
        migrations.RunPython(remap_stages_forward, remap_stages_backward),
    ]
