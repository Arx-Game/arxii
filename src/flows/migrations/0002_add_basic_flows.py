"""Add skeletons for very basic flows that are foundational to gameplay."""

# Generated by Django 5.2.4 on 2025-07-24 03:43

from django.db import migrations


def create_basic_flows(apps, schema_editor):
    FlowDefinition = apps.get_model("flows", "FlowDefinition")
    FlowStepDefinition = apps.get_model("flows", "FlowStepDefinition")
    Event = apps.get_model("flows", "Event")

    look_flow, _ = FlowDefinition.objects.get_or_create(
        name="look",
        defaults={
            "description": "Send a formatted description of the target to the caller.",
        },
    )

    look_event, _ = Event.objects.get_or_create(
        name="look_at", defaults={"label": "Look At"}
    )

    # Create the generic pre-move event used by several flows.
    move_event, _ = Event.objects.get_or_create(
        name="object_pre_move",
        defaults={"label": "Object Pre-Move"},
    )

    step1, _ = FlowStepDefinition.objects.get_or_create(
        flow=look_flow,
        parent=None,
        action="emit_flow_event",
        variable_name=look_event.name,
        defaults={
            "parameters": {
                "event_type": "look_at",
                "data": {"caller": "$caller", "target": "$target"},
            }
        },
    )

    step2, _ = FlowStepDefinition.objects.get_or_create(
        flow=look_flow,
        parent_id=step1.id,
        action="call_service_function",
        variable_name="get_formatted_description",
        defaults={
            "parameters": {"obj": "$target", "mode": "$mode", "result_variable": "desc"}
        },
    )

    step3, _ = FlowStepDefinition.objects.get_or_create(
        flow=look_flow,
        parent_id=step2.id,
        action="emit_flow_event_for_each",
        variable_name=look_event.name,
        defaults={
            "parameters": {
                "iterable": "$target.contents",
                "event_type": look_event.name,
                "data": {"caller": "$caller", "target": "$item"},
                "item_key": None,
            }
        },
    )

    FlowStepDefinition.objects.get_or_create(
        flow=look_flow,
        parent_id=step3.id,
        action="call_service_function",
        variable_name="send_message",
        defaults={"parameters": {"recipient": "$caller", "text": "$desc"}},
    )

    # Get flow
    get_flow, _ = FlowDefinition.objects.get_or_create(
        name="get",
        defaults={"description": "Move an item to the caller."},
    )

    step1, _ = FlowStepDefinition.objects.get_or_create(
        flow=get_flow,
        parent=None,
        action="emit_flow_event",
        variable_name=move_event.name,
        defaults={
            "parameters": {
                "event_type": move_event.name,
                "data": {
                    "caller": "$caller",
                    "target": "$target",
                    "destination": "$caller",
                },
            }
        },
    )

    step2, _ = FlowStepDefinition.objects.get_or_create(
        flow=get_flow,
        parent_id=step1.id,
        action="call_service_function",
        variable_name="move_object",
        defaults={"parameters": {"obj": "$target", "destination": "$caller"}},
    )

    FlowStepDefinition.objects.get_or_create(
        flow=get_flow,
        parent_id=step2.id,
        action="call_service_function",
        variable_name="message_location",
        defaults={
            "parameters": {
                "caller": "$caller",
                "target": "$target",
                "text": ["$You() $conj(pick) up $you(target)."],
            }
        },
    )

    # Drop flow
    drop_flow, _ = FlowDefinition.objects.get_or_create(
        name="drop",
        defaults={"description": "Drop an item into the room."},
    )

    step1, _ = FlowStepDefinition.objects.get_or_create(
        flow=drop_flow,
        parent=None,
        action="emit_flow_event",
        variable_name=move_event.name,
        defaults={
            "parameters": {
                "event_type": move_event.name,
                "data": {
                    "caller": "$caller",
                    "target": "$target",
                    "destination": "$caller.location",
                },
            }
        },
    )

    step2, _ = FlowStepDefinition.objects.get_or_create(
        flow=drop_flow,
        parent_id=step1.id,
        action="call_service_function",
        variable_name="move_object",
        defaults={"parameters": {"obj": "$target", "destination": "$caller.location"}},
    )

    FlowStepDefinition.objects.get_or_create(
        flow=drop_flow,
        parent_id=step2.id,
        action="call_service_function",
        variable_name="message_location",
        defaults={
            "parameters": {
                "caller": "$caller",
                "target": "$target",
                "text": ["$You() $conj(drop) $you(target)."],
            }
        },
    )

    # Give flow
    give_flow, _ = FlowDefinition.objects.get_or_create(
        name="give",
        defaults={"description": "Give an item to another character."},
    )

    step1, _ = FlowStepDefinition.objects.get_or_create(
        flow=give_flow,
        parent=None,
        action="emit_flow_event",
        variable_name=move_event.name,
        defaults={
            "parameters": {
                "event_type": move_event.name,
                "data": {
                    "caller": "$caller",
                    "target": "$target",
                    "destination": "$recipient",
                },
            }
        },
    )

    step2, _ = FlowStepDefinition.objects.get_or_create(
        flow=give_flow,
        parent_id=step1.id,
        action="call_service_function",
        variable_name="move_object",
        defaults={"parameters": {"obj": "$target", "destination": "$recipient"}},
    )

    FlowStepDefinition.objects.get_or_create(
        flow=give_flow,
        parent_id=step2.id,
        action="call_service_function",
        variable_name="message_location",
        defaults={
            "parameters": {
                "caller": "$caller",
                "target": "$recipient",
                "text": ["$You() $conj(give) $you(target) something."],
            }
        },
    )

    # Home flow
    home_flow, _ = FlowDefinition.objects.get_or_create(
        name="home",
        defaults={"description": "Return the caller to their home."},
    )

    step1, _ = FlowStepDefinition.objects.get_or_create(
        flow=home_flow,
        parent=None,
        action="emit_flow_event",
        variable_name=move_event.name,
        defaults={
            "parameters": {
                "event_type": move_event.name,
                "data": {
                    "caller": "$caller",
                    "target": "$caller",
                    "destination": "$caller.home",
                },
            }
        },
    )

    step2, _ = FlowStepDefinition.objects.get_or_create(
        flow=home_flow,
        parent_id=step1.id,
        action="call_service_function",
        variable_name="move_object",
        defaults={"parameters": {"obj": "$caller", "destination": "$caller.home"}},
    )

    FlowStepDefinition.objects.get_or_create(
        flow=home_flow,
        parent_id=step2.id,
        action="call_service_function",
        variable_name="message_location",
        defaults={
            "parameters": {
                "caller": "$caller",
                "text": ["$You() $conj(go) home."],
            }
        },
    )


class Migration(migrations.Migration):

    dependencies = [
        ("flows", "0001_initial"),
    ]

    operations = [
        migrations.RunPython(
            create_basic_flows, reverse_code=migrations.RunPython.noop
        ),
    ]
